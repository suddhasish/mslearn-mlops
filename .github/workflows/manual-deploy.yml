# Manual Infrastructure Deployment
# Simple workflow for manual deployments - always available, never skipped

name: Manual Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - prod
      branch:
        description: 'Branch to deploy from'
        required: false
        type: string
        default: 'deployment-pipeline'
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - plan
          - apply
          - destroy
        default: plan

permissions:
  contents: read

env:
  TERRAFORM_VERSION: '1.6.0'
  WORKING_DIR: './infrastructure'

jobs:
  deploy:
    name: Deploy ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment }}
      url: https://portal.azure.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CLIENT_SECRET }}

      - name: Setup Terraform Environment Variables
        run: |
          echo "ARM_CLIENT_ID=${{ fromJson(secrets.AZURE_CLIENT_SECRET).clientId }}" >> $GITHUB_ENV
          echo "ARM_CLIENT_SECRET=${{ fromJson(secrets.AZURE_CLIENT_SECRET).clientSecret }}" >> $GITHUB_ENV
          echo "ARM_SUBSCRIPTION_ID=${{ fromJson(secrets.AZURE_CLIENT_SECRET).subscriptionId }}" >> $GITHUB_ENV
          echo "ARM_TENANT_ID=${{ fromJson(secrets.AZURE_CLIENT_SECRET).tenantId }}" >> $GITHUB_ENV

      - name: Create terraform.tfvars
        run: |
          cd ${{ env.WORKING_DIR }}
          
          if [ "${{ github.event.inputs.environment }}" == "dev" ]; then
            cat > terraform.tfvars << EOF
          environment                = "dev"
          project_name              = "${{ secrets.PROJECT_NAME }}"
          location                  = "${{ secrets.AZURE_LOCATION }}"
          owner                     = "MLOps Team"
          cost_center               = "ML Engineering"
          business_unit             = "Data Science"
          
          # Network Configuration
          allowed_subnet_cidr       = "10.0.0.0/8"
          enable_private_endpoints  = false
          enable_purge_protection   = false
          
          # Compute Configuration
          ml_compute_name          = "cpu-cluster"
          aks_node_count          = 2
          aks_vm_size             = "Standard_D4s_v3"
          aks_enable_auto_scaling = true
          aks_min_nodes           = 1
          aks_max_nodes           = 5
          
          # Monitoring
          enable_container_insights = true
          log_retention_days       = 30
          
          # Security
          enable_network_policy    = true
          enable_rbac             = true
          enable_aad_integration  = true
          
          # Cost Management
          enable_cost_alerts      = true
          monthly_budget_amount   = 1000
          budget_alert_threshold  = 80
          
          # DevOps Integration
          enable_devops_integration = true
          devops_project_name       = "MLOps Project"
          
          # Services
          enable_data_factory      = true
          enable_synapse          = false
          enable_cognitive_services = false
          
          # Notifications
          notification_email       = "${{ secrets.NOTIFICATION_EMAIL }}"
          enable_slack_notifications = false
          EOF
          else
            cat > terraform.tfvars << EOF
          environment                = "prod"
          project_name              = "${{ secrets.PROJECT_NAME }}"
          location                  = "${{ secrets.AZURE_LOCATION }}"
          owner                     = "MLOps Team"
          cost_center               = "ML Engineering"
          business_unit             = "Data Science"
          
          # Network Configuration - PRODUCTION SECURITY
          allowed_subnet_cidr       = "10.0.0.0/8"
          enable_private_endpoints  = true
          enable_purge_protection   = true
          
          # Compute Configuration
          ml_compute_name          = "cpu-cluster"
          aks_node_count          = 3
          aks_vm_size             = "Standard_D4s_v3"
          aks_enable_auto_scaling = true
          aks_min_nodes           = 2
          aks_max_nodes           = 10
          
          # Monitoring
          enable_container_insights = true
          log_retention_days       = 90
          
          # Security
          enable_network_policy    = true
          enable_rbac             = true
          enable_aad_integration  = true
          
          # Cost Management
          enable_cost_alerts      = true
          monthly_budget_amount   = 5000
          budget_alert_threshold  = 80
          
          # DevOps Integration
          enable_devops_integration = true
          devops_project_name       = "MLOps Project"
          
          # Services
          enable_data_factory      = true
          enable_synapse          = false
          enable_cognitive_services = false
          
          # Backup
          enable_backup           = true
          backup_retention_days   = 90
          
          # Notifications
          notification_email       = "${{ secrets.NOTIFICATION_EMAIL }}"
          enable_slack_notifications = false
          EOF
          fi

      - name: Terraform Init
        run: |
          cd ${{ env.WORKING_DIR }}
          terraform init

      - name: Terraform Plan
        if: github.event.inputs.action == 'plan' || github.event.inputs.action == 'apply'
        run: |
          cd ${{ env.WORKING_DIR }}
          terraform plan -out=tfplan

      - name: Terraform Apply
        if: github.event.inputs.action == 'apply'
        run: |
          cd ${{ env.WORKING_DIR }}
          terraform apply -auto-approve tfplan

      - name: Terraform Destroy
        if: github.event.inputs.action == 'destroy'
        run: |
          cd ${{ env.WORKING_DIR }}
          terraform destroy -auto-approve

      - name: Terraform Output
        if: github.event.inputs.action == 'apply'
        run: |
          cd ${{ env.WORKING_DIR }}
          terraform output -json > outputs.json
          cat outputs.json

      - name: Upload Outputs
        if: github.event.inputs.action == 'apply'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs-${{ github.event.inputs.environment }}
          path: ${{ env.WORKING_DIR }}/outputs.json

      - name: Create Deployment Summary
        if: github.event.inputs.action == 'apply'
        run: |
          cd ${{ env.WORKING_DIR }}
          
          echo "## ðŸš€ Infrastructure Deployment - ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployed Resources" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Name |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Group | $(jq -r '.resource_group_name.value' outputs.json) |" >> $GITHUB_STEP_SUMMARY
          echo "| ML Workspace | $(jq -r '.ml_workspace_name.value' outputs.json) |" >> $GITHUB_STEP_SUMMARY
          echo "| AKS Cluster | $(jq -r '.aks_cluster_name.value' outputs.json) |" >> $GITHUB_STEP_SUMMARY
          echo "| Storage Account | $(jq -r '.storage_account_name.value' outputs.json) |" >> $GITHUB_STEP_SUMMARY
          echo "| Container Registry | $(jq -r '.container_registry_name.value' outputs.json) |" >> $GITHUB_STEP_SUMMARY
          echo "| Key Vault | $(jq -r '.key_vault_name.value' outputs.json) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

name: Setup Monitoring Stack

on:
  workflow_dispatch:
    inputs:
      aks_cluster_name:
        description: 'AKS cluster name'
        required: false
        default: 'mlopsnew-dev-aks'
      resource_group:
        description: 'Resource group'
        required: false
        default: 'mlopsnew-dev-rg'

env:
  AZURE_SUBSCRIPTION_ID: b2b8a5e6-9a34-494b-ba62-fe9be95bd398

jobs:
  setup-monitoring:
    name: Setup Prometheus + Grafana
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ github.event.inputs.resource_group || 'mlopsnew-dev-rg' }} \
            --name ${{ github.event.inputs.aks_cluster_name || 'mlopsnew-dev-aks' }} \
            --overwrite-existing

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Check if Prometheus is already installed
        id: check_prometheus
        run: |
          if helm list -n monitoring | grep -q prometheus; then
            echo "already_installed=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Prometheus is already installed"
          else
            echo "already_installed=false" >> $GITHUB_OUTPUT
          fi

      - name: Install Prometheus Operator + Grafana
        if: steps.check_prometheus.outputs.already_installed == 'false'
        run: |
          set -euo pipefail
          
          echo "ðŸ“Š Installing Prometheus Operator + Grafana stack..."
          
          # Add Helm repo
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo update
          
          # Create namespace
          kubectl create namespace monitoring --dry-run=client -o yaml | kubectl apply -f -
          
          # Install stack
          helm install prometheus prometheus-community/kube-prometheus-stack \
            --namespace monitoring \
            --set prometheus.prometheusSpec.serviceMonitorSelectorNilUsesHelmValues=false \
            --set prometheus.prometheusSpec.podMonitorSelectorNilUsesHelmValues=false \
            --set prometheus.prometheusSpec.ruleSelectorNilUsesHelmValues=false \
            --set prometheus.prometheusSpec.retention=7d \
            --set prometheus.prometheusSpec.storageSpec.volumeClaimTemplate.spec.resources.requests.storage=20Gi \
            --set grafana.enabled=true \
            --set grafana.adminPassword='${{ secrets.GRAFANA_PASSWORD || 'Admin123!' }}' \
            --set alertmanager.enabled=true \
            --wait --timeout=10m
          
          echo "âœ… Prometheus Operator installed"

      - name: Wait for monitoring pods
        run: |
          echo "Waiting for monitoring pods to be ready..."
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=prometheus -n monitoring --timeout=300s || true
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=grafana -n monitoring --timeout=300s || true

      - name: Apply ServiceMonitor and Alerts
        run: |
          set -euo pipefail
          
          echo "ðŸ“ˆ Applying ServiceMonitor and Alert Rules..."
          
          # Apply ServiceMonitor
          kubectl apply -f kubernetes/ml-inference-servicemonitor.yaml
          
          # Apply Alert Rules
          kubectl apply -f kubernetes/ml-inference-alerts.yaml
          
          echo "âœ… Monitoring configuration applied"

      - name: Get Grafana admin password
        id: get_password
        run: |
          PASSWORD=$(kubectl get secret -n monitoring prometheus-grafana -o jsonpath="{.data.admin-password}" | base64 --decode)
          echo "::add-mask::$PASSWORD"
          echo "password=$PASSWORD" >> $GITHUB_OUTPUT

      - name: Display access information
        run: |
          echo "### ðŸ“Š Monitoring Stack Setup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Prometheus Operator**: Installed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Grafana**: Installed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **AlertManager**: Installed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **ServiceMonitor**: Applied" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Alert Rules**: Applied" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Access Instructions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Grafana" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "kubectl port-forward -n monitoring svc/prometheus-grafana 3000:80" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "- URL: http://localhost:3000" >> $GITHUB_STEP_SUMMARY
          echo "- Username: \`admin\`" >> $GITHUB_STEP_SUMMARY
          echo "- Password: \`${{ steps.get_password.outputs.password }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Prometheus" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "kubectl port-forward -n monitoring svc/prometheus-kube-prometheus-prometheus 9090:9090" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "- URL: http://localhost:9090" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### AlertManager" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "kubectl port-forward -n monitoring svc/prometheus-kube-prometheus-alertmanager 9093:9093" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "- URL: http://localhost:9093" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Example Prometheus Queries" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Request Rate**: \`rate(model_predictions_total[5m])\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Latency P95**: \`histogram_quantile(0.95, rate(model_prediction_duration_seconds_bucket[5m]))\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Error Rate**: \`rate(model_errors_total[5m]) / rate(model_predictions_total[5m])\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Pod CPU**: \`rate(container_cpu_usage_seconds_total{namespace=\"production\",pod=~\"ml-inference.*\"}[5m])\`" >> $GITHUB_STEP_SUMMARY

      - name: Verify monitoring
        run: |
          echo ""
          echo "Monitoring Resources:"
          kubectl get all -n monitoring
          echo ""
          kubectl get servicemonitor -n production
          echo ""
          kubectl get prometheusrule -n production

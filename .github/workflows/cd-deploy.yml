name: CD - MLOps Blue/Green Deployment with Approval

# This workflow uses Terraform-deployed DEV infrastructure
# Both staging and production endpoints are deployed in DEV environment
# - Staging endpoint: ml-endpoint-staging (for testing)
# - Production endpoint: ml-endpoint-production (for blue/green deployment)
# 
# Infrastructure: mlopsnew-dev-* resources (deployed via Terraform)
# See INFRASTRUCTURE_INTEGRATION.md for details

on:
  workflow_dispatch:
    inputs:
      model_name:
        description: 'Model name to deploy'
        required: true
        default: 'diabetes_classification'
      model_version:
        description: 'Model version (e.g., 1, 2, latest)'
        required: true
        default: 'latest'
  repository_dispatch:
    types: [aml_model_registered]

# Prevent concurrent deployments to same environment
concurrency:
  group: cd-deployment-${{ github.ref }}
  cancel-in-progress: false

env:
  PYTHON_VERSION: '3.11'
  
  # Infrastructure (Terraform-deployed DEV environment)
  # Note: Both staging and production use DEV infrastructure
  AZURE_SUBSCRIPTION_ID: 'b2b8a5e6-9a34-494b-ba62-fe9be95bd398'
  RESOURCE_GROUP: 'mlopsnew-dev-rg'
  ML_WORKSPACE: 'mlopsnew-dev-mlw'
  
  # Endpoint configuration
  # Staging endpoint: For initial testing and validation
  AZURE_ML_STAGING_ENDPOINT_NAME: ml-endpoint-staging
  STAGING_DEPLOYMENT_NAME: staging-deployment
  
  # Production endpoint: For blue/green deployment with gradual rollout
  AZURE_ML_PRODUCTION_ENDPOINT_NAME: ml-endpoint-production
  PROD_BLUE_DEPLOYMENT_NAME: blue-deployment
  PROD_GREEN_DEPLOYMENT_NAME: green-deployment
  
  # Deployment configuration
  MAX_WAIT_ITERATIONS: 30
  WAIT_INTERVAL_SECONDS: 10

jobs:
  # Centralized input resolution
  resolve-inputs:
    name: Resolve Deployment Inputs
    runs-on: ubuntu-latest
    outputs:
      model_name: ${{ steps.resolve.outputs.model_name }}
      model_version: ${{ steps.resolve.outputs.model_version }}
      aml_workspace: ${{ steps.resolve.outputs.aml_workspace }}
      resource_group: ${{ steps.resolve.outputs.resource_group }}
      subscription_id: ${{ steps.resolve.outputs.subscription_id }}
      deployment_id: ${{ steps.resolve.outputs.deployment_id }}
    steps:
      - name: Generate deployment ID
        id: deployment_id
        run: echo "id=deploy-$(date +%Y%m%d-%H%M%S)-${{ github.run_id }}" >> $GITHUB_OUTPUT

      - name: Resolve all inputs
        id: resolve
        run: |
          # Use DEV infrastructure (Terraform-deployed)
          echo "model_name=${{ github.event.inputs.model_name || github.event.client_payload.model_name || 'diabetes_classification' }}" >> $GITHUB_OUTPUT
          echo "model_version=${{ github.event.inputs.model_version || github.event.client_payload.model_version || 'latest' }}" >> $GITHUB_OUTPUT
          echo "aml_workspace=${{ env.ML_WORKSPACE }}" >> $GITHUB_OUTPUT
          echo "resource_group=${{ env.RESOURCE_GROUP }}" >> $GITHUB_OUTPUT
          echo "subscription_id=${{ env.AZURE_SUBSCRIPTION_ID }}" >> $GITHUB_OUTPUT
          echo "deployment_id=${{ steps.deployment_id.outputs.id }}" >> $GITHUB_OUTPUT

      - name: Display infrastructure configuration
        run: |
          echo "### ðŸ—ï¸ Infrastructure Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Using DEV Infrastructure** (Staging and Production endpoints in same workspace)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Group | ${{ steps.resolve.outputs.resource_group }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ML Workspace | ${{ steps.resolve.outputs.aml_workspace }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Subscription | ${{ steps.resolve.outputs.subscription_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Endpoints:**" >> $GITHUB_STEP_SUMMARY
          echo "- Staging: `${{ env.AZURE_ML_STAGING_ENDPOINT_NAME }}`" >> $GITHUB_STEP_SUMMARY
          echo "- Production: `${{ env.AZURE_ML_PRODUCTION_ENDPOINT_NAME }}`" >> $GITHUB_STEP_SUMMARY

      - name: Log deployment configuration
        run: |
          echo "### ðŸš€ Deployment Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Model Name | ${{ steps.resolve.outputs.model_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Model Version | ${{ steps.resolve.outputs.model_version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployment ID | ${{ steps.resolve.outputs.deployment_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Infrastructure | DEV (simulating prod) |" >> $GITHUB_STEP_SUMMARY

  deploy-staging:
    name: Deploy to Staging Environment
    needs: resolve-inputs
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: ${{ steps.get_endpoint.outputs.ENDPOINT_URL }}
    outputs:
      endpoint_url: ${{ steps.get_endpoint.outputs.ENDPOINT_URL }}
      deployment_state: ${{ steps.deployment_status.outputs.state }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install azure-ai-ml azure-identity

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Install Azure ML CLI extension
        run: |
          az config set extension.use_dynamic_install=yes_without_prompt
          az extension add --name ml --yes --upgrade

      - name: Create or update staging endpoint
        id: create_staging_endpoint
        continue-on-error: true
        run: |
          set -euo pipefail
          
          echo "Creating/updating staging endpoint: $AZURE_ML_STAGING_ENDPOINT_NAME"
          
          az ml online-endpoint create \
            --name "$AZURE_ML_STAGING_ENDPOINT_NAME" \
            --workspace-name "${{ needs.resolve-inputs.outputs.aml_workspace }}" \
            --resource-group "${{ needs.resolve-inputs.outputs.resource_group }}" \
            --subscription "${{ needs.resolve-inputs.outputs.subscription_id }}" \
            --auth-mode key \
            --tags environment=staging \
                   deployed_by="${{ github.actor }}" \
                   deployment_run="${{ github.run_id }}" \
                   deployment_id="${{ needs.resolve-inputs.outputs.deployment_id }}" \
                   model_name="${{ needs.resolve-inputs.outputs.model_name }}" \
                   model_version="${{ needs.resolve-inputs.outputs.model_version }}"

      - name: Handle endpoint creation result
        if: steps.create_staging_endpoint.outcome == 'failure'
        run: |
          echo "::warning::Endpoint may already exist - verifying status..."
          
          status=$(az ml online-endpoint show \
            --name "$AZURE_ML_STAGING_ENDPOINT_NAME" \
            --workspace-name "${{ needs.resolve-inputs.outputs.aml_workspace }}" \
            --resource-group "${{ needs.resolve-inputs.outputs.resource_group }}" \
            --subscription "${{ needs.resolve-inputs.outputs.subscription_id }}" \
            --query provisioning_state -o tsv)
          
          if [ "$status" != "Succeeded" ]; then
            echo "::error::Endpoint exists but is in $status state"
            exit 1
          fi
          
          echo "âœ“ Endpoint already exists and is healthy"

      - name: Deploy model to staging
        id: deploy_staging
        run: |
          set -euo pipefail
          
          echo "Deploying model ${{ needs.resolve-inputs.outputs.model_name }}:${{ needs.resolve-inputs.outputs.model_version }}"
          
          az ml online-deployment create \
            --endpoint-name "$AZURE_ML_STAGING_ENDPOINT_NAME" \
            --name "$STAGING_DEPLOYMENT_NAME" \
            --model "${{ needs.resolve-inputs.outputs.model_name }}:${{ needs.resolve-inputs.outputs.model_version }}" \
            --workspace-name "${{ needs.resolve-inputs.outputs.aml_workspace }}" \
            --resource-group "${{ needs.resolve-inputs.outputs.resource_group }}" \
            --subscription "${{ needs.resolve-inputs.outputs.subscription_id }}" \
            --instance-type Standard_DS2_v2 \
            --instance-count 1 \
            --all-traffic \
            --set environment_variables.DEPLOYMENT_ID="${{ needs.resolve-inputs.outputs.deployment_id }}" \
            --set environment_variables.MODEL_VERSION="${{ needs.resolve-inputs.outputs.model_version }}" \
            --tags environment=staging \
                   model_name="${{ needs.resolve-inputs.outputs.model_name }}" \
                   model_version="${{ needs.resolve-inputs.outputs.model_version }}" \
            --overwrite

      - name: Wait for staging deployment to be healthy
        id: wait_staging
        run: |
          set -euo pipefail
          
          echo "â³ Waiting up to $((MAX_WAIT_ITERATIONS * WAIT_INTERVAL_SECONDS / 60)) minutes for deployment..."
          
          for i in $(seq 1 $MAX_WAIT_ITERATIONS); do
            status=$(az ml online-deployment show \
              --endpoint-name "$AZURE_ML_STAGING_ENDPOINT_NAME" \
              --name "$STAGING_DEPLOYMENT_NAME" \
              --workspace-name "${{ needs.resolve-inputs.outputs.aml_workspace }}" \
              --resource-group "${{ needs.resolve-inputs.outputs.resource_group }}" \
              --subscription "${{ needs.resolve-inputs.outputs.subscription_id }}" \
              --query provisioning_state -o tsv)
            
            echo "[$i/$MAX_WAIT_ITERATIONS] Deployment state: $status"
            
            if [ "$status" = "Succeeded" ]; then
              echo "âœ“ Deployment provisioned successfully"
              exit 0
            elif [ "$status" = "Failed" ]; then
              echo "::error::Deployment provisioning failed"
              
              # Get error details
              az ml online-deployment show \
                --endpoint-name "$AZURE_ML_STAGING_ENDPOINT_NAME" \
                --name "$STAGING_DEPLOYMENT_NAME" \
                --workspace-name "${{ needs.resolve-inputs.outputs.aml_workspace }}" \
                --resource-group "${{ needs.resolve-inputs.outputs.resource_group }}" \
                --subscription "${{ needs.resolve-inputs.outputs.subscription_id }}" \
                --query '{state:provisioning_state,error:provisioning_state_error}' -o json
              
              exit 1
            fi
            
            sleep $WAIT_INTERVAL_SECONDS
          done
          
          echo "::error::Timeout waiting for deployment (exceeded $((MAX_WAIT_ITERATIONS * WAIT_INTERVAL_SECONDS)) seconds)"
          exit 1

      - name: Get staging endpoint details
        id: get_endpoint
        run: |
          set -euo pipefail
          
          ENDPOINT_URL=$(az ml online-endpoint show \
            --name "$AZURE_ML_STAGING_ENDPOINT_NAME" \
            --workspace-name "${{ needs.resolve-inputs.outputs.aml_workspace }}" \
            --resource-group "${{ needs.resolve-inputs.outputs.resource_group }}" \
            --subscription "${{ needs.resolve-inputs.outputs.subscription_id }}" \
            --query scoring_uri -o tsv)
          
          # Get key but mask it immediately
          ENDPOINT_KEY=$(az ml online-endpoint get-credentials \
            --name "$AZURE_ML_STAGING_ENDPOINT_NAME" \
            --workspace-name "${{ needs.resolve-inputs.outputs.aml_workspace }}" \
            --resource-group "${{ needs.resolve-inputs.outputs.resource_group }}" \
            --subscription "${{ needs.resolve-inputs.outputs.subscription_id }}" \
            --query primaryKey -o tsv)
          
          # Mask the key before any output
          echo "::add-mask::$ENDPOINT_KEY"
          
          echo "ENDPOINT_URL=$ENDPOINT_URL" >> $GITHUB_OUTPUT
          echo "ENDPOINT_KEY=$ENDPOINT_KEY" >> $GITHUB_OUTPUT
          
          echo "âœ“ Staging endpoint URL: $ENDPOINT_URL"

      - name: Run staging endpoint tests
        env:
          ENDPOINT_URL: ${{ steps.get_endpoint.outputs.ENDPOINT_URL }}
          ENDPOINT_KEY: ${{ steps.get_endpoint.outputs.ENDPOINT_KEY }}
        run: |
          set -euo pipefail
          
          echo "ðŸ§ª Running endpoint tests..."
          
          if [ ! -f "scripts/test_endpoint.py" ]; then
            echo "::warning::Test script not found at scripts/test_endpoint.py - skipping tests"
            exit 0
          fi
          
          python scripts/test_endpoint.py --url "$ENDPOINT_URL" --key "$ENDPOINT_KEY"
          
          echo "âœ“ All staging tests passed"

      - name: Set deployment status
        id: deployment_status
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "state=success" >> $GITHUB_OUTPUT
          else
            echo "state=failure" >> $GITHUB_OUTPUT
          fi

      - name: Update deployment summary
        if: always()
        run: |
          echo "### ðŸ“Š Staging Deployment Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.deployment_status.outputs.state }}" = "success" ]; then
            echo "âœ… **Status**: Deployment successful" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”— **Endpoint**: ${{ steps.get_endpoint.outputs.ENDPOINT_URL }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status**: Deployment failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Model**: ${{ needs.resolve-inputs.outputs.model_name }}:${{ needs.resolve-inputs.outputs.model_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Instance**: Standard_DS2_v2 (x1)" >> $GITHUB_STEP_SUMMARY
          echo "**Infrastructure**: DEV (mlopsnew-dev-rg)" >> $GITHUB_STEP_SUMMARY

  prepare-production:
    name: Prepare Production Blue/Green Deployment
    needs: [resolve-inputs, deploy-staging]
    runs-on: ubuntu-latest
    if: needs.deploy-staging.outputs.deployment_state == 'success'
    outputs:
      green_deployment_url: ${{ steps.get_green_endpoint.outputs.DEPLOYMENT_URL }}
      production_ready: ${{ steps.green_status.outputs.ready }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install azure-ai-ml azure-identity

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Install Azure ML CLI extension
        run: |
          az config set extension.use_dynamic_install=yes_without_prompt
          az extension add --name ml --yes --upgrade

      - name: Create or update production endpoint
        id: create_prod_endpoint
        continue-on-error: true
        run: |
          set -euo pipefail
          
          echo "Creating/updating production endpoint: $AZURE_ML_PRODUCTION_ENDPOINT_NAME"
          
          az ml online-endpoint create \
            --name "$AZURE_ML_PRODUCTION_ENDPOINT_NAME" \
            --workspace-name "${{ needs.resolve-inputs.outputs.aml_workspace }}" \
            --resource-group "${{ needs.resolve-inputs.outputs.resource_group }}" \
            --subscription "${{ needs.resolve-inputs.outputs.subscription_id }}" \
            --auth-mode key \
            --tags environment=production \
                   deployed_by="${{ github.actor }}" \
                   deployment_run="${{ github.run_id }}" \
                   deployment_id="${{ needs.resolve-inputs.outputs.deployment_id }}" \
                   model_name="${{ needs.resolve-inputs.outputs.model_name }}" \
                   model_version="${{ needs.resolve-inputs.outputs.model_version }}"

      - name: Handle production endpoint creation result
        if: steps.create_prod_endpoint.outcome == 'failure'
        run: |
          echo "::warning::Endpoint may already exist - verifying status..."
          
          status=$(az ml online-endpoint show \
            --name "$AZURE_ML_PRODUCTION_ENDPOINT_NAME" \
            --workspace-name "${{ needs.resolve-inputs.outputs.aml_workspace }}" \
            --resource-group "${{ needs.resolve-inputs.outputs.resource_group }}" \
            --subscription "${{ needs.resolve-inputs.outputs.subscription_id }}" \
            --query provisioning_state -o tsv)
          
          if [ "$status" != "Succeeded" ]; then
            echo "::error::Endpoint exists but is in $status state"
            exit 1
          fi
          
          echo "âœ“ Production endpoint already exists and is healthy"

      - name: Check for existing deployments
        id: check_existing
        run: |
          set -euo pipefail
          
          existing_count=$(az ml online-deployment list \
            --endpoint-name "$AZURE_ML_PRODUCTION_ENDPOINT_NAME" \
            --workspace-name "${{ needs.resolve-inputs.outputs.aml_workspace }}" \
            --resource-group "${{ needs.resolve-inputs.outputs.resource_group }}" \
            --subscription "${{ needs.resolve-inputs.outputs.subscription_id }}" \
            --query "length([])" -o tsv)
          
          echo "count=$existing_count" >> $GITHUB_OUTPUT
          echo "Found $existing_count existing deployment(s)"

      - name: Ensure blue deployment exists (first-time setup)
        if: steps.check_existing.outputs.count == '0'
        run: |
          set -euo pipefail
          
          echo "âš ï¸  No existing deployments - creating initial BLUE deployment"
          
          az ml online-deployment create \
            --endpoint-name "$AZURE_ML_PRODUCTION_ENDPOINT_NAME" \
            --name "$PROD_BLUE_DEPLOYMENT_NAME" \
            --model "${{ needs.resolve-inputs.outputs.model_name }}:${{ needs.resolve-inputs.outputs.model_version }}" \
            --workspace-name "${{ needs.resolve-inputs.outputs.aml_workspace }}" \
            --resource-group "${{ needs.resolve-inputs.outputs.resource_group }}" \
            --subscription "${{ needs.resolve-inputs.outputs.subscription_id }}" \
            --instance-type Standard_DS3_v2 \
            --instance-count 2 \
            --all-traffic \
            --set environment_variables.DEPLOYMENT_ID="${{ needs.resolve-inputs.outputs.deployment_id }}" \
            --set environment_variables.MODEL_VERSION="${{ needs.resolve-inputs.outputs.model_version }}" \
            --set environment_variables.DEPLOYMENT_COLOR="blue" \
            --tags environment=production \
                   deployment_color=blue \
                   model_name="${{ needs.resolve-inputs.outputs.model_name }}" \
                   model_version="${{ needs.resolve-inputs.outputs.model_version }}" \
            --overwrite
          
          echo "âœ“ Initial BLUE deployment created with 100% traffic"

      - name: Create GREEN deployment (no traffic)
        id: create_green
        run: |
          set -euo pipefail
          
          echo "Creating GREEN deployment with new model version"
          
          az ml online-deployment create \
            --endpoint-name "$AZURE_ML_PRODUCTION_ENDPOINT_NAME" \
            --name "$PROD_GREEN_DEPLOYMENT_NAME" \
            --model "${{ needs.resolve-inputs.outputs.model_name }}:${{ needs.resolve-inputs.outputs.model_version }}" \
            --workspace-name "${{ needs.resolve-inputs.outputs.aml_workspace }}" \
            --resource-group "${{ needs.resolve-inputs.outputs.resource_group }}" \
            --subscription "${{ needs.resolve-inputs.outputs.subscription_id }}" \
            --instance-type Standard_DS3_v2 \
            --instance-count 1 \
            --set environment_variables.DEPLOYMENT_ID="${{ needs.resolve-inputs.outputs.deployment_id }}" \
            --set environment_variables.MODEL_VERSION="${{ needs.resolve-inputs.outputs.model_version }}" \
            --set environment_variables.DEPLOYMENT_COLOR="green" \
            --tags environment=production \
                   deployment_color=green \
                   model_name="${{ needs.resolve-inputs.outputs.model_name }}" \
                   model_version="${{ needs.resolve-inputs.outputs.model_version }}" \
            --overwrite

      - name: Wait for GREEN deployment to be ready
        run: |
          set -euo pipefail
          
          echo "â³ Waiting for GREEN deployment to be ready..."
          
          for i in $(seq 1 $MAX_WAIT_ITERATIONS); do
            status=$(az ml online-deployment show \
              --endpoint-name "$AZURE_ML_PRODUCTION_ENDPOINT_NAME" \
              --name "$PROD_GREEN_DEPLOYMENT_NAME" \
              --workspace-name "${{ needs.resolve-inputs.outputs.aml_workspace }}" \
              --resource-group "${{ needs.resolve-inputs.outputs.resource_group }}" \
              --subscription "${{ needs.resolve-inputs.outputs.subscription_id }}" \
              --query provisioning_state -o tsv)
            
            echo "[$i/$MAX_WAIT_ITERATIONS] GREEN deployment state: $status"
            
            if [ "$status" = "Succeeded" ]; then
              echo "âœ“ GREEN deployment is ready"
              exit 0
            elif [ "$status" = "Failed" ]; then
              echo "::error::GREEN deployment failed"
              az ml online-deployment show \
                --endpoint-name "$AZURE_ML_PRODUCTION_ENDPOINT_NAME" \
                --name "$PROD_GREEN_DEPLOYMENT_NAME" \
                --workspace-name "${{ needs.resolve-inputs.outputs.aml_workspace }}" \
                --resource-group "${{ needs.resolve-inputs.outputs.resource_group }}" \
                --subscription "${{ needs.resolve-inputs.outputs.subscription_id }}" \
                --query '{state:provisioning_state,error:provisioning_state_error}' -o json
              exit 1
            fi
            
            sleep $WAIT_INTERVAL_SECONDS
          done
          
          echo "::error::Timeout waiting for GREEN deployment"
          exit 1

      - name: Get GREEN deployment details
        id: get_green_endpoint
        run: |
          set -euo pipefail
          
          # Get deployment-specific URL for isolated testing
          DEPLOYMENT_URL=$(az ml online-deployment show \
            --endpoint-name "$AZURE_ML_PRODUCTION_ENDPOINT_NAME" \
            --name "$PROD_GREEN_DEPLOYMENT_NAME" \
            --workspace-name "${{ needs.resolve-inputs.outputs.aml_workspace }}" \
            --resource-group "${{ needs.resolve-inputs.outputs.resource_group }}" \
            --subscription "${{ needs.resolve-inputs.outputs.subscription_id }}" \
            --query scoring_uri -o tsv)
          
          # Get endpoint key and mask it
          ENDPOINT_KEY=$(az ml online-endpoint get-credentials \
            --name "$AZURE_ML_PRODUCTION_ENDPOINT_NAME" \
            --workspace-name "${{ needs.resolve-inputs.outputs.aml_workspace }}" \
            --resource-group "${{ needs.resolve-inputs.outputs.resource_group }}" \
            --subscription "${{ needs.resolve-inputs.outputs.subscription_id }}" \
            --query primaryKey -o tsv)
          
          echo "::add-mask::$ENDPOINT_KEY"
          
          echo "DEPLOYMENT_URL=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "ENDPOINT_KEY=$ENDPOINT_KEY" >> $GITHUB_OUTPUT
          
          echo "âœ“ GREEN deployment URL: $DEPLOYMENT_URL"

      - name: Test GREEN deployment in isolation
        env:
          DEPLOYMENT_URL: ${{ steps.get_green_endpoint.outputs.DEPLOYMENT_URL }}
          ENDPOINT_KEY: ${{ steps.get_green_endpoint.outputs.ENDPOINT_KEY }}
        run: |
          set -euo pipefail
          
          echo "ðŸ§ª Testing GREEN deployment in isolation (before receiving traffic)..."
          
          if [ ! -f "scripts/test_endpoint.py" ]; then
            echo "::warning::Test script not found - skipping isolated tests"
            exit 0
          fi
          
          python scripts/test_endpoint.py --url "$DEPLOYMENT_URL" --key "$ENDPOINT_KEY"
          
          echo "âœ“ GREEN deployment tests passed"

      - name: Show current traffic distribution
        run: |
          echo "ðŸ“Š Current production traffic distribution:"
          az ml online-endpoint show \
            --name "$AZURE_ML_PRODUCTION_ENDPOINT_NAME" \
            --workspace-name "${{ needs.resolve-inputs.outputs.aml_workspace }}" \
            --resource-group "${{ needs.resolve-inputs.outputs.resource_group }}" \
            --subscription "${{ needs.resolve-inputs.outputs.subscription_id }}" \
            --query traffic -o json

      - name: Set production readiness status
        id: green_status
        run: |
          echo "ready=true" >> $GITHUB_OUTPUT

      - name: Update preparation summary
        run: |
          echo "### ðŸŽ¯ Production Preparation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… GREEN deployment created and validated" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Deployment URL**: ${{ steps.get_green_endpoint.outputs.DEPLOYMENT_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸  **Current status**: GREEN has 0% traffic (awaiting approval for rollout)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next step**: Manual approval required to begin gradual traffic shift"

  await-production-approval:
    name: ðŸ”’ Await Production Approval
    needs: [resolve-inputs, deploy-staging, prepare-production]
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://portal.azure.com/#@/resource/subscriptions/${{ needs.resolve-inputs.outputs.subscription_id }}/resourceGroups/${{ needs.resolve-inputs.outputs.resource_group }}/providers/Microsoft.MachineLearningServices/workspaces/${{ needs.resolve-inputs.outputs.aml_workspace }}/endpoints/${{ env.AZURE_ML_PRODUCTION_ENDPOINT_NAME }}
    steps:
      - name: Display approval information
        run: |
          echo "### ðŸ”’ Production Deployment Approval Required" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Staging deployment**: Successful" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **GREEN deployment**: Created and tested in isolation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Details:**" >> $GITHUB_STEP_SUMMARY
          echo "- Model: ${{ needs.resolve-inputs.outputs.model_name }}:${{ needs.resolve-inputs.outputs.model_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- Deployment ID: ${{ needs.resolve-inputs.outputs.deployment_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- Endpoint: $AZURE_ML_PRODUCTION_ENDPOINT_NAME" >> $GITHUB_STEP_SUMMARY
          echo "- Staging URL: ${{ needs.deploy-staging.outputs.endpoint_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- Production URL (GREEN): ${{ needs.prepare-production.outputs.green_deployment_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Rollout Plan:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Shift 10% traffic to GREEN â†’ smoke test" >> $GITHUB_STEP_SUMMARY
          echo "2. Shift 50% traffic to GREEN â†’ smoke test" >> $GITHUB_STEP_SUMMARY
          echo "3. Shift 100% traffic to GREEN â†’ smoke test" >> $GITHUB_STEP_SUMMARY
          echo "4. Automatic rollback to BLUE if any test fails" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸  **Approve this deployment to begin the gradual traffic rollout**"

  gradual-rollout:
    name: ðŸš€ Gradual Blueâ†’Green Traffic Rollout
    needs: [resolve-inputs, await-production-approval]
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://portal.azure.com/#@/resource/subscriptions/${{ needs.resolve-inputs.outputs.subscription_id }}/resourceGroups/${{ needs.resolve-inputs.outputs.resource_group }}/providers/Microsoft.MachineLearningServices/workspaces/${{ needs.resolve-inputs.outputs.aml_workspace }}/endpoints/${{ env.AZURE_ML_PRODUCTION_ENDPOINT_NAME }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install azure-ai-ml azure-identity

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Install Azure ML CLI extension
        run: |
          az config set extension.use_dynamic_install=yes_without_prompt
          az extension add --name ml --yes --upgrade

      - name: Execute gradual traffic shift with validation
        id: rollout
        env:
          ENDPOINT_NAME: ${{ env.AZURE_ML_PRODUCTION_ENDPOINT_NAME }}
          BLUE: ${{ env.PROD_BLUE_DEPLOYMENT_NAME }}
          GREEN: ${{ env.PROD_GREEN_DEPLOYMENT_NAME }}
          WORKSPACE: ${{ needs.resolve-inputs.outputs.aml_workspace }}
          RESOURCE_GROUP: ${{ needs.resolve-inputs.outputs.resource_group }}
          SUBSCRIPTION: ${{ needs.resolve-inputs.outputs.subscription_id }}
        run: |
          set -euo pipefail
          
          echo "ðŸš€ Starting gradual rollout from BLUE to GREEN"
          
          # Function to run smoke tests
          smoke_test() {
            local test_name="$1"
            
            echo "ðŸ§ª Running smoke test: $test_name"
            
            ENDPOINT_URL=$(az ml online-endpoint show \
              --name "$ENDPOINT_NAME" \
              --workspace-name "$WORKSPACE" \
              --resource-group "$RESOURCE_GROUP" \
              --subscription "$SUBSCRIPTION" \
              --query scoring_uri -o tsv)
            
            KEY=$(az ml online-endpoint get-credentials \
              --name "$ENDPOINT_NAME" \
              --workspace-name "$WORKSPACE" \
              --resource-group "$RESOURCE_GROUP" \
              --subscription "$SUBSCRIPTION" \
              --query primaryKey -o tsv)
            
            echo "::add-mask::$KEY"
            
            if [ ! -f "scripts/test_endpoint.py" ]; then
              echo "::warning::Test script not found - skipping smoke test"
              return 0
            fi
            
            if python scripts/test_endpoint.py --url "$ENDPOINT_URL" --key "$KEY"; then
              echo "âœ… Smoke test passed: $test_name"
              return 0
            else
              echo "::error::Smoke test failed: $test_name"
              return 1
            fi
          }
          
          # Function to rollback to BLUE
          rollback_to_blue() {
            local reason="$1"
            
            echo "::error::âŒ ROLLBACK INITIATED: $reason"
            echo "Rolling back: routing 100% traffic to BLUE ($BLUE)"
            
            az ml online-endpoint update \
              --name "$ENDPOINT_NAME" \
              --workspace-name "$WORKSPACE" \
              --resource-group "$RESOURCE_GROUP" \
              --subscription "$SUBSCRIPTION" \
              --traffic "{\"$BLUE\":100}"
            
            echo "âœ“ Rollback complete - 100% traffic routed to BLUE"
            echo "rollback_performed=true" >> $GITHUB_OUTPUT
          }
          
          # Function to update traffic
          update_traffic() {
            local blue_pct=$1
            local green_pct=$2
            
            echo "ðŸ”„ Shifting traffic: BLUE=$blue_pct%, GREEN=$green_pct%"
            
            if [ "$blue_pct" -eq 0 ]; then
              TRAFFIC_JSON="{\"$GREEN\":$green_pct}"
            else
              TRAFFIC_JSON="{\"$BLUE\":$blue_pct,\"$GREEN\":$green_pct}"
            fi
            
            echo "Applying traffic: $TRAFFIC_JSON"
            
            az ml online-endpoint update \
              --name "$ENDPOINT_NAME" \
              --workspace-name "$WORKSPACE" \
              --resource-group "$RESOURCE_GROUP" \
              --subscription "$SUBSCRIPTION" \
              --traffic "$TRAFFIC_JSON"
            
            echo "â³ Waiting 30s for traffic propagation and metrics collection..."
            sleep 30
          }
          
          # Initialize rollback flag
          echo "rollback_performed=false" >> $GITHUB_OUTPUT
          
          # Phase 1: 10% GREEN traffic
          echo "ðŸ“Š Phase 1: Shifting 10% traffic to GREEN"
          if ! update_traffic 90 10; then
            rollback_to_blue "Failed to update traffic to 10%"
            exit 1
          fi
          
          if ! smoke_test "10% traffic on GREEN"; then
            rollback_to_blue "Smoke test failed at 10%"
            exit 1
          fi
          
          echo "âœ… Phase 1 complete: 10% traffic validated"
          
          # Phase 2: 50% GREEN traffic
          echo "ðŸ“Š Phase 2: Shifting 50% traffic to GREEN"
          if ! update_traffic 50 50; then
            rollback_to_blue "Failed to update traffic to 50%"
            exit 1
          fi
          
          if ! smoke_test "50% traffic on GREEN"; then
            rollback_to_blue "Smoke test failed at 50%"
            exit 1
          fi
          
          echo "âœ… Phase 2 complete: 50% traffic validated"
          
          # Phase 3: 100% GREEN traffic
          echo "ðŸ“Š Phase 3: Shifting 100% traffic to GREEN"
          if ! update_traffic 0 100; then
            rollback_to_blue "Failed to update traffic to 100%"
            exit 1
          fi
          
          if ! smoke_test "100% traffic on GREEN"; then
            rollback_to_blue "Smoke test failed at 100%"
            exit 1
          fi
          
          echo "âœ… Phase 3 complete: 100% traffic validated"
          echo "ðŸŽ‰ Rollout successful! GREEN deployment now serving 100% of production traffic"

      - name: Scale down BLUE deployment for cost savings
        if: success()
        continue-on-error: true
        run: |
          echo "ðŸ’° Scaling BLUE deployment to 0 instances for cost optimization"
          
          az ml online-deployment update \
            --endpoint-name "${{ env.AZURE_ML_PRODUCTION_ENDPOINT_NAME }}" \
            --name "${{ env.PROD_BLUE_DEPLOYMENT_NAME }}" \
            --workspace-name "${{ needs.resolve-inputs.outputs.aml_workspace }}" \
            --resource-group "${{ needs.resolve-inputs.outputs.resource_group }}" \
            --subscription "${{ needs.resolve-inputs.outputs.subscription_id }}" \
            --instance-count 0
          
          echo "âœ“ BLUE deployment scaled to 0 (kept for quick rollback if needed)"

      - name: Update rollout summary
        if: always()
        run: |
          echo "### ðŸ“Š Production Rollout Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.rollout.outputs.rollback_performed }}" = "true" ]; then
            echo "âŒ **Status**: Rollout failed - rolled back to BLUE" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸  **Current state**: 100% traffic on BLUE deployment" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Action required**: Investigate failure, fix issues, and retry deployment" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ job.status }}" = "success" ]; then
            echo "âœ… **Status**: Rollout successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ‰ **Current state**: 100% traffic on GREEN deployment" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Rollout phases completed:**" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… 10% traffic â†’ validated" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… 50% traffic â†’ validated" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… 100% traffic â†’ validated" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ’° BLUE deployment scaled to 0 instances for cost savings" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status**: Rollout failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment details:**" >> $GITHUB_STEP_SUMMARY
          echo "- Model: ${{ needs.resolve-inputs.outputs.model_name }}:${{ needs.resolve-inputs.outputs.model_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- Deployment ID: ${{ needs.resolve-inputs.outputs.deployment_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- Endpoint: ${{ env.AZURE_ML_PRODUCTION_ENDPOINT_NAME }}" >> $GITHUB_STEP_SUMMARY

  post-deployment-validation:
    name: ðŸ” Post-Deployment Validation
    needs: [resolve-inputs, gradual-rollout]
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Install Azure ML CLI extension
        run: |
          az config set extension.use_dynamic_install=yes_without_prompt
          az extension add --name ml --yes --upgrade

      - name: Verify final traffic distribution
        run: |
          echo "ðŸ“Š Verifying final traffic distribution"
          
          traffic=$(az ml online-endpoint show \
            --name "${{ env.AZURE_ML_PRODUCTION_ENDPOINT_NAME }}" \
            --workspace-name "${{ needs.resolve-inputs.outputs.aml_workspace }}" \
            --resource-group "${{ needs.resolve-inputs.outputs.resource_group }}" \
            --subscription "${{ needs.resolve-inputs.outputs.subscription_id }}" \
            --query traffic -o json)
          
          echo "Current traffic: $traffic"
          
          green_traffic=$(echo "$traffic" | jq -r '.["${{ env.PROD_GREEN_DEPLOYMENT_NAME }}"] // 0')
          
          if [ "$green_traffic" != "100" ]; then
            echo "::error::Expected GREEN to have 100% traffic, but got $green_traffic%"
            exit 1
          fi
          
          echo "âœ… Verified: GREEN deployment has 100% traffic"

      - name: Log deployment metrics
        run: |
          echo "### ðŸ“ˆ Deployment Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Deployment Timestamp | $(date -u +%Y-%m-%dT%H:%M:%SZ) |" >> $GITHUB_STEP_SUMMARY
          echo "| Model Name | ${{ needs.resolve-inputs.outputs.model_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Model Version | ${{ needs.resolve-inputs.outputs.model_version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployment ID | ${{ needs.resolve-inputs.outputs.deployment_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployed By | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow Run | [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| Infrastructure | DEV (mlopsnew-dev-*) |" >> $GITHUB_STEP_SUMMARY
          echo "| Instance Type | Standard_DS3_v2 |" >> $GITHUB_STEP_SUMMARY
          echo "| Instance Count | 2 (Blue/Green deployments) |" >> $GITHUB_STEP_SUMMARY

      - name: Notify deployment success
        if: always()
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const summary = `
            ## ðŸŽ‰ Production Deployment Successful
            
            **Model**: ${{ needs.resolve-inputs.outputs.model_name }}:${{ needs.resolve-inputs.outputs.model_version }}
            **Deployment ID**: ${{ needs.resolve-inputs.outputs.deployment_id }}
            **Endpoint**: ${{ env.AZURE_ML_PRODUCTION_ENDPOINT_NAME }}
            **Deployed by**: @${{ github.actor }}
            
            âœ… Gradual rollout completed: 10% â†’ 50% â†’ 100%
            âœ… All smoke tests passed
            âœ… GREEN deployment now serving 100% production traffic
            `;
            
            console.log(summary);
